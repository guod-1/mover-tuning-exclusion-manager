{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
        <h1 class="text-3xl font-bold text-white">Movies <span id="visibleCount" class="text-lg font-normal text-gray-400">({{ total }})</span></h1>
        <input type="text" id="movieSearch" oninput="applyFilters()"
               placeholder="Search movies..."
               class="bg-gray-900 border border-gray-700 text-gray-300 text-sm rounded-lg px-4 py-2 w-72 focus:ring-1 focus:ring-teal-500 outline-none">
    </div>

    <!-- Tag filters -->
    {% if all_tags %}
    <div class="mb-6">
        <div class="flex items-center gap-3">
            <label class="text-xs font-bold text-gray-500 uppercase tracking-widest shrink-0">Filter by Tag</label>
            <button type="button" onclick="toggleTagPanel()"
                    id="tagPanelBtn"
                    class="flex items-center gap-2 bg-gray-900 border border-gray-700 text-gray-300 text-sm rounded-lg px-3 py-2 outline-none hover:border-teal-600 transition">
                <span id="tagPanelLabel">All tags</span>
                <span class="text-gray-600 text-xs">▾</span>
            </button>
            <button type="button" onclick="clearTagFilters()" class="text-xs text-gray-500 hover:text-gray-300 transition hidden" id="clearTagsBtn">✕ Clear</button>
        </div>
        <div id="tagPanel" class="hidden mt-2 bg-gray-900 border border-gray-700 rounded-lg p-3 flex flex-wrap gap-2">
            <label class="flex items-center gap-1.5 cursor-pointer group">
                <input type="checkbox" value="__untagged__" onchange="applyTagFilters()" class="tag-checkbox accent-teal-500">
                <span class="text-xs text-gray-400 group-hover:text-white transition">No Tags</span>
            </label>
            {% for tag in all_tags %}
            <label class="flex items-center gap-1.5 cursor-pointer group">
                <input type="checkbox" value="{{ tag }}" onchange="applyTagFilters()" class="tag-checkbox accent-teal-500">
                <span class="text-xs text-gray-400 group-hover:text-white transition">{{ tag }}</span>
            </label>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="bg-gray-800 shadow rounded-lg overflow-hidden">
        <table id="moviesTable" class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-900">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                </tr>
            </thead>
            <tbody class="bg-gray-800 divide-y divide-gray-700">
                {% for movie in movies %}
                <tr data-title="{{ movie.title | lower }}" data-tags="{{ movie.tags | join(',') | lower }}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{{ movie.title }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">{{ movie.year }}</td>
                    <td class="px-6 py-4 text-sm text-gray-400">
                        <div class="flex flex-wrap gap-1">
                            {% for tag in movie.tags %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-teal-900 text-teal-200">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not movies %}
        <div class="text-center py-12"><p class="text-gray-500">No movies found</p></div>
        {% endif %}
    </div>
</div>

<script>
let activeTags = new Set();

function toggleTagPanel() {
    const panel = document.getElementById('tagPanel');
    panel.classList.toggle('hidden');
}

function applyTagFilters() {
    activeTags = new Set(
        [...document.querySelectorAll('.tag-checkbox:checked')].map(c => c.value)
    );
    const label = document.getElementById('tagPanelLabel');
    const clearBtn = document.getElementById('clearTagsBtn');
    if (activeTags.size === 0) {
        label.textContent = 'All tags';
        clearBtn.classList.add('hidden');
    } else {
        label.textContent = activeTags.size === 1 ? [...activeTags][0] : `${activeTags.size} tags selected`;
        clearBtn.classList.remove('hidden');
    }
    applyFilters();
}

function clearTagFilters() {
    document.querySelectorAll('.tag-checkbox').forEach(c => c.checked = false);
    activeTags = new Set();
    document.getElementById('tagPanelLabel').textContent = 'All tags';
    document.getElementById('clearTagsBtn').classList.add('hidden');
    applyFilters();
}

function applyFilters() {
    const search = document.getElementById('movieSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#moviesTable tbody tr');
    let visible = 0;
    rows.forEach(row => {
        const title = row.dataset.title || '';
        const tags = row.dataset.tags || '';
        const matchesSearch = !search || title.includes(search);
        let matchesTag = true;
        if (activeTags.size > 0) {
            const tagList = tags ? tags.split(',') : [];
            matchesTag = [...activeTags].every(t => {
                if (t === '__untagged__') return tagList.length === 0;
                return tagList.includes(t.toLowerCase());
            });
        }
        row.style.display = matchesSearch && matchesTag ? '' : 'none';
        if (matchesSearch && matchesTag) visible++;
    });
    document.getElementById('visibleCount').textContent = `(${visible})`;
}
</script>
{% endblock %}
